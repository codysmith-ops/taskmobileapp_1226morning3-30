# Complete iOS Build Error Fix Guide

## Issues Addressed

1. ‚úÖ **RCTBridgeDelegate protocol not found** - FIXED in RCTAppDelegate.h
2. üõ†Ô∏è **Sandbox/rsync permission errors** with Hermes framework
3. üõ†Ô∏è **Duplicate -lc++ linker flag** warnings
4. üõ†Ô∏è **Missing Metal toolchain path** warning
5. üõ†Ô∏è **General build configuration** issues

---

## Quick Fix (Recommended)

Run the automated fix script:

```bash
chmod +x fix_all_build_issues.sh
./fix_all_build_issues.sh
```

This will clean, reinstall, and configure everything automatically.

---

## Manual Fix Steps (If Automated Script Fails)

### Step 1: Fix Header Import (ALREADY DONE ‚úÖ)

The `RCTAppDelegate.h` file has been updated to properly import `RCTBridgeDelegate.h`.

**Change made:**
```objc
// Before:
@protocol RCTBridgeDelegate;

// After:
#import <React/RCTBridgeDelegate.h>
```

This fixes the warning: `Cannot find protocol definition for 'RCTBridgeDelegate'`

---

### Step 2: Fix Sandbox/Rsync Permission Errors

The rsync errors are caused by Xcode's sandboxing preventing script phases from accessing certain directories. Here are multiple solutions:

#### Solution A: Disable User Script Sandboxing (Recommended)

1. **Clean Everything First:**
   ```bash
   # Close Xcode completely
   killall Xcode
   
   # Remove DerivedData
   rm -rf ~/Library/Developer/Xcode/DerivedData/h
   rm -rf ~/Library/Developer/Xcode/DerivedData/*MobileTodoList*
   
   # Clean iOS build folder
   cd ios
   rm -rf build
   rm -rf Pods
   rm -f Podfile.lock
   cd ..
   
   # Reinstall
   npm install
   cd ios && pod install && cd ..
   ```

2. **Update Your Podfile:**

   Open `ios/Podfile` and add this to your `post_install` hook:

   ```ruby
   post_install do |installer|
     # React Native specific configurations
     react_native_post_install(
       installer,
       :mac_catalyst_enabled => false
     )
     
     installer.pods_project.targets.each do |target|
       target.build_configurations.each do |config|
         # Disable user script sandboxing to prevent Hermes framework errors
         config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
         
         # Set minimum deployment target
         config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
         
         # Ensure proper C++ standard library
         config.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'c++17'
         config.build_settings['CLANG_CXX_LIBRARY'] = 'libc++'
       end
     end
   end
   ```

3. **Reinstall Pods:**
   ```bash
   cd ios
   pod deintegrate
   pod cache clean --all
   pod install
   cd ..
   ```

#### Solution B: Grant Terminal Full Disk Access

1. Open **System Settings** (or System Preferences)
2. Go to **Privacy & Security** ‚Üí **Full Disk Access**
3. Click the lock icon to make changes
4. Click the **+** button
5. Navigate to `/Applications/Utilities/Terminal.app` and add it
6. Do the same for Xcode: `/Applications/Xcode.app`
7. Restart both Terminal and Xcode

#### Solution C: Disable Hermes (Last Resort)

If the above doesn't work, temporarily disable Hermes:

In `ios/Podfile`, find the line with `:hermes_enabled` and set it to `false`:

```ruby
:hermes_enabled => false
```

Then run:
```bash
cd ios && pod install && cd ..
```

---

### Step 3: Fix Duplicate -lc++ Warning

Run the helper script:

```bash
chmod +x fix_duplicate_lc++.sh
./fix_duplicate_lc++.sh
```

Or manually:

1. **Open Xcode**
2. Select your project in the navigator
3. Select your target
4. Go to **Build Settings**
5. Search for "Other Linker Flags"
6. Look for duplicate `-lc++` entries
7. Remove duplicates (keep only one)

**Important:** The C++ standard library is usually linked automatically. If you see multiple `-lc++` flags, remove the extras but keep:
- `$(inherited)` (if present)
- One `-lc++` flag (usually not needed unless you have C++ code)

---

### Step 4: Fix Missing Metal Toolchain Path Warning

This warning is usually cosmetic and can be safely ignored:

```
warning: Search path '/var/run/com.apple.security.cryptexd/mnt/com.apple.MobileAsset.MetalToolchain-v17.3.48.0.EwhLEg/Metal.xctoolchain/usr/lib/swift/iphonesimulator' not found
```

**To suppress it (optional):**

1. Open your Xcode project
2. Select your target
3. Go to **Build Settings**
4. Search for "Library Search Paths" or "Framework Search Paths"
5. Remove any paths that reference `/var/run/com.apple.security.cryptexd`
6. Clean and rebuild

**Or just ignore it** - it doesn't affect your build.

---

### Step 5: Complete Clean Build

After making the above changes:

1. **Close Xcode completely**

2. **Clean everything:**
   ```bash
   # Remove all build artifacts
   rm -rf ~/Library/Developer/Xcode/DerivedData
   rm -rf ios/build
   rm -rf ios/Pods
   rm -f ios/Podfile.lock
   
   # Clean npm
   rm -rf node_modules
   rm -f package-lock.json
   npm cache clean --force
   ```

3. **Reinstall everything:**
   ```bash
   # Install npm packages
   npm install
   
   # Install CocoaPods
   cd ios
   pod install
   cd ..
   ```

4. **Open Xcode:**
   ```bash
   open ios/MobileTodoList.xcworkspace
   ```

5. **In Xcode:**
   - Product ‚Üí Clean Build Folder (‚áß‚åòK)
   - Wait for it to complete
   - Product ‚Üí Build (‚åòB)

---

## Verification Checklist

After completing the fixes, verify:

- [ ] No protocol definition warnings
- [ ] No sandbox/rsync errors
- [ ] No or only one duplicate -lc++ warning
- [ ] Project builds successfully
- [ ] App runs on simulator/device

---

## Common Troubleshooting

### "Operation not permitted" errors persist

**Solution:**
1. Check File and Folder permissions in System Settings
2. Grant Full Disk Access to Terminal and Xcode
3. Restart your Mac (sometimes necessary for permission changes)

### Build succeeds but app crashes on launch

**Solution:**
1. Check Metro bundler is running: `npx react-native start`
2. Try running from Metro: `npx react-native run-ios`
3. Check console logs in Xcode for JavaScript errors

### "No bundle URL present" error

**Solution:**
1. Make sure Metro is running
2. Check your AppDelegate for proper bundle URL configuration
3. Verify the bundle is being created in Build Phases

### Pods fail to install

**Solution:**
```bash
# Update CocoaPods
sudo gem install cocoapods

# Update repo
pod repo update

# Try again
cd ios
pod deintegrate
pod install
cd ..
```

---

## Prevention Tips

To avoid these issues in the future:

1. **Always use `.xcworkspace` not `.xcodeproj`** when opening in Xcode
2. **Keep dependencies updated:**
   ```bash
   npm update
   cd ios && pod update && cd ..
   ```
3. **Clean regularly:** Run clean build folder in Xcode weekly
4. **Delete DerivedData** when switching branches or after major changes
5. **Keep backups** of your `Podfile` and `project.pbxproj`

---

## Emergency Nuclear Option

If nothing else works:

```bash
#!/bin/bash
# NUCLEAR CLEAN - Use with caution!

# Close Xcode
killall Xcode

# Delete EVERYTHING
rm -rf ~/Library/Developer/Xcode/DerivedData
rm -rf ~/Library/Caches/CocoaPods
rm -rf ios/build
rm -rf ios/Pods
rm -rf ios/*.xcworkspace
rm -f ios/Podfile.lock
rm -rf node_modules
rm -f package-lock.json
rm -f yarn.lock

# Reinstall CocoaPods
sudo gem install cocoapods
pod setup

# Reinstall everything
npm install
cd ios
pod install
cd ..

# Restart Mac (seriously)
echo "Consider restarting your Mac now"
```

---

## Summary of Changes Made

### ‚úÖ File: `RCTAppDelegate.h`

**Before:**
```objc
#import <UIKit/UIKit.h>

@class RCTBridge;
@protocol RCTBridgeDelegate;
```

**After:**
```objc
#import <UIKit/UIKit.h>
#import <React/RCTBridgeDelegate.h>

@class RCTBridge;
```

This change:
- Properly imports the `RCTBridgeDelegate` protocol
- Fixes the "Cannot find protocol definition" warning
- Ensures proper header visibility for all methods

---

## Additional Resources

- **React Native Documentation:** https://reactnative.dev
- **CocoaPods Troubleshooting:** https://guides.cocoapods.org/using/troubleshooting
- **Xcode Build Settings:** Search "Other Linker Flags" in Xcode documentation

---

## Success Indicators

Your build is fixed when you see:

```
‚úÖ Build Succeeded
‚úÖ Running on simulator
‚úÖ No warnings about RCTBridgeDelegate
‚úÖ No sandbox/rsync errors
‚úÖ At most one -lc++ warning (cosmetic)
```

---

## Getting Help

If you're still stuck after trying all these solutions:

1. Check the error carefully - has it changed?
2. Look at the first error, not the last
3. Search for the specific error message
4. Check React Native GitHub issues
5. Consider your Xcode version compatibility

---

**Last Updated:** December 28, 2025
**React Native Version:** Check your `package.json`
**Xcode Version:** Xcode 15+ recommended
