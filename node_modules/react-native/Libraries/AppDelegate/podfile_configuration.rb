# Recommended Podfile Configuration
# Add this to your ios/Podfile to prevent common build issues

# This is a TEMPLATE - merge these settings into your existing Podfile
# DO NOT replace your entire Podfile with this content!

# ============================================================================
# POST-INSTALL HOOK - Add/Merge this section
# ============================================================================

post_install do |installer|
  # React Native specific post-install (call this if you have it)
  # react_native_post_install(
  #   installer,
  #   :mac_catalyst_enabled => false
  # )
  
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      
      # ======================================================================
      # FIX: Sandbox/rsync permission errors with Hermes framework
      # ======================================================================
      # Disable user script sandboxing to allow build scripts to access
      # XCFramework intermediates and other build artifacts
      config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
      
      # ======================================================================
      # FIX: Deployment target warnings
      # ======================================================================
      # Set minimum iOS deployment target (adjust as needed for your project)
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
      
      # ======================================================================
      # FIX: C++ standard library and language version
      # ======================================================================
      # Ensure C++17 standard (required by React Native)
      config.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'c++17'
      
      # Use libc++ (prevents duplicate library warnings)
      config.build_settings['CLANG_CXX_LIBRARY'] = 'libc++'
      
      # ======================================================================
      # OPTIMIZATION: Build performance improvements
      # ======================================================================
      # Enable dead code stripping
      config.build_settings['DEAD_CODE_STRIPPING'] = 'YES'
      
      # Enable aggressive optimization for release builds
      if config.name == 'Release'
        config.build_settings['GCC_OPTIMIZATION_LEVEL'] = 'fast'
        config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-O'
      end
      
      # ======================================================================
      # FIX: Header search paths
      # ======================================================================
      # Ensure header search paths include inherited values
      config.build_settings['HEADER_SEARCH_PATHS'] ||= ['$(inherited)']
      
      # ======================================================================
      # FIX: Code signing for simulator builds
      # ======================================================================
      # Don't require code signing for simulator builds
      if config.name.downcase.include?('debug')
        config.build_settings['CODE_SIGN_IDENTITY'] = ''
        config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
        config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
      end
      
      # ======================================================================
      # FIX: Bitcode (disabled for React Native)
      # ======================================================================
      config.build_settings['ENABLE_BITCODE'] = 'NO'
      
      # ======================================================================
      # FIX: Architecture settings
      # ======================================================================
      # Support for both Intel and Apple Silicon Macs
      config.build_settings['ONLY_ACTIVE_ARCH'] = config.name == 'Debug' ? 'YES' : 'NO'
      
      # Exclude arm64 simulator architecture if needed for older dependencies
      # Uncomment the line below if you encounter architecture-related issues:
      # config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64'
      
      # ======================================================================
      # FIX: Swift version
      # ======================================================================
      # Set Swift version if your project uses Swift
      # config.build_settings['SWIFT_VERSION'] ||= '5.0'
      
      # ======================================================================
      # FIX: Module stability
      # ======================================================================
      # Enable module stability for Swift (if applicable)
      # config.build_settings['BUILD_LIBRARY_FOR_DISTRIBUTION'] = 'YES'
      
    end
  end
  
  # ============================================================================
  # ADDITIONAL: Fix specific pod issues if needed
  # ============================================================================
  
  # Fix for Flipper (if you're using it and having issues)
  # flipper_post_install(installer)
  
  # Fix for specific pods that might have issues
  installer.pods_project.targets.each do |target|
    # Example: Force RCT-Folly to use correct deployment target
    if target.name == 'RCT-Folly'
      target.build_configurations.each do |config|
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
      end
    end
    
    # Example: Fix for specific warning-prone pods
    if ['Yoga', 'RCTRequired', 'RCTTypeSafety'].include?(target.name)
      target.build_configurations.each do |config|
        config.build_settings['GCC_WARN_INHIBIT_ALL_WARNINGS'] = 'YES'
        config.build_settings['CLANG_WARN_DOCUMENTATION_COMMENTS'] = 'NO'
      end
    end
  end
  
end

# ============================================================================
# COMPLETE EXAMPLE PODFILE
# ============================================================================
# Below is a complete example Podfile structure for reference
# ============================================================================

=begin

# Uncomment the next line to define a global platform for your project
platform :ios, '13.0'

require_relative '../node_modules/react-native/scripts/react_native_pods'
require_relative '../node_modules/@react-native-community/cli-platform-ios/native_modules'

target 'MobileTodoList' do
  config = use_native_modules!

  use_react_native!(
    :path => config[:reactNativePath],
    # Hermes is now recommended for React Native
    :hermes_enabled => true,
    :fabric_enabled => false,
    :flipper_configuration => FlipperConfiguration.disabled,
    :app_clip_enabled => false
  )

  target 'MobileTodoListTests' do
    inherit! :complete
    # Pods for testing
  end

  post_install do |installer|
    react_native_post_install(
      installer,
      :mac_catalyst_enabled => false
    )
    
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
        config.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'c++17'
        config.build_settings['CLANG_CXX_LIBRARY'] = 'libc++'
        config.build_settings['DEAD_CODE_STRIPPING'] = 'YES'
        config.build_settings['ENABLE_BITCODE'] = 'NO'
        config.build_settings['HEADER_SEARCH_PATHS'] ||= ['$(inherited)']
      end
    end
  end
end

=end

# ============================================================================
# USAGE INSTRUCTIONS
# ============================================================================
=begin

1. Open your ios/Podfile
2. Find the existing post_install hook (or create one)
3. Add the build settings from above
4. Save the file
5. Run: cd ios && pod install && cd ..
6. Clean build folder in Xcode (Cmd+Shift+K)
7. Build (Cmd+B)

Key settings explained:

- ENABLE_USER_SCRIPT_SANDBOXING = NO
  Allows Xcode build scripts to access Hermes framework and other resources
  Fixes: "Sandbox: rsync deny(1) file-read-data" errors

- IPHONEOS_DEPLOYMENT_TARGET = 13.0
  Sets minimum iOS version (adjust based on your requirements)
  Fixes: Deployment target warnings

- CLANG_CXX_LIBRARY = libc++
  Explicitly sets C++ standard library
  Fixes: Duplicate -lc++ warnings

- ENABLE_BITCODE = NO
  Disables bitcode (not supported by React Native)
  Fixes: Bitcode-related build failures

- DEAD_CODE_STRIPPING = YES
  Removes unused code, reduces app size
  Optimization: Smaller binaries

=end
